<!DOCTYPE html>
<html lang="">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="icon" href="favicon.png">
	<title>Multi-function picture batch processing v3.0 No need to upload files</title>
	<script>
		var idbKeyval = function (t) {
			"use strict";

			function e(t) {
				return new Promise(((e, n) => {
					t.oncomplete = t.onsuccess = () => e(t.result), t.onabort = t.onerror = () => n(t.error)
				}))
			}

			function n(t, n) {
				const r = indexedDB.open(t);
				r.onupgradeneeded = () => r.result.createObjectStore(n);
				const o = e(r);
				return (t, e) => o.then((r => e(r.transaction(n, t).objectStore(n))))
			}
			let r;

			function o() {
				return r || (r = n("keyval-store", "keyval")), r
			}

			function u(t, n) {
				return t("readonly", (t => (t.openCursor().onsuccess = function () {
					this.result && (n(this.result), this.result.continue())
				}, e(t.transaction))))
			}
			return t.clear = function (t = o()) {
				return t("readwrite", (t => (t.clear(), e(t.transaction))))
			}, t.createStore = n, t.del = function (t, n = o()) {
				return n("readwrite", (n => (n.delete(t), e(n.transaction))))
			}, t.entries = function (t = o()) {
				const e = [];
				return u(t, (t => e.push([t.key, t.value]))).then((() => e))
			}, t.get = function (t, n = o()) {
				return n("readonly", (n => e(n.get(t))))
			}, t.getMany = function (t, n = o()) {
				return n("readonly", (n => Promise.all(t.map((t => e(n.get(t)))))))
			}, t.keys = function (t = o()) {
				const e = [];
				return u(t, (t => e.push(t.key))).then((() => e))
			}, t.promisifyRequest = e, t.set = function (t, n, r = o()) {
				return r("readwrite", (r => (r.put(n, t), e(r.transaction))))
			}, t.setMany = function (t, n = o()) {
				return n("readwrite", (n => (t.forEach((t => n.put(t[1], t[0]))), e(n.transaction))))
			}, t.update = function (t, n, r = o()) {
				return r("readwrite", (r => new Promise(((o, u) => {
					r.get(t).onsuccess = function () {
						try {
							r.put(n(this.result), t), o(e(r.transaction))
						} catch (t) {
							u(t)
						}
					}
				}))))
			}, t.values = function (t = o()) {
				const e = [];
				return u(t, (t => e.push(t.value))).then((() => e))
			}, t
		}({});
	</script>
	<style>
		* {
			padding: 0;
			margin: 0;
		}

		body {
			background-color: #202223;
		}

		.loadPage {
			position: fixed;
			z-index: 9999;
			width: 100%;
			height: 100%;
			left: 0;
			top: 0;
			background-color: #202223;
			display: none;
			align-items: center;
			justify-content: center;
			flex-direction: column;
			color: #2eb5de
		}

		.loadPage .p {
			width: 100%;
			max-width: 500px;
			height: 10px;
			background-color: #2d2f31;
			overflow: hidden;
			border-radius: 6px;
			margin: 30px 0 10px 0
		}

		.loadPage .p div {
			height: 100%;
			width: 30%;
			background-color: #37d1c8;
			background-image: linear-gradient(-34deg, #2eb5de 0%, #37d1c8 100%);
		}

		.loadPage h2 {
			font-size: 70px;
			line-height: 90px;
		}

		.loadPage h3 {
			color: #7b7e80;
			font-size: 20px;
		}
	</style>
</head>

<body>
	<div class="loadPage">
		<h2>1%</h2>
		<div class="p">
			<div></div>
		</div>
		<h3>LOADING...</h3><a target="_blank" href="./v2.html">v2.2 -></a>
	</div>
	<noscript><strong>We're sorry but vue_2 doesn't work properly without JavaScript enabled. Please enable it
			to continue.</strong></noscript>
	<div id="app"></div>

</body>

</html>
<script>
	window.CACHE_VERSION = '3.0.61'
	window.CACHE_LIST = {}
	window.CACHE_FN = _ => {
		let cdnList = [{
				name: 'app.js',
				url: ['js/app.8eb49d22.222.js']
			}, {
				name: 'avif_enc_worker_all_in.js',
				url: ['js/avif_enc_worker_all_in.js']
			}, {
				name: 'imagequant_worker_all_in.js',
				url: ['js/imagequant_worker_all_in.js']
			}, {
				name: 'squoosh_oxipng_worker_all_in.js',
				url: ['js/squoosh_oxipng_worker_all_in.js']
			}, {
				name: 'mozjpeg_enc_worker_all_in.js',
				url: ['js/mozjpeg_enc_worker_all_in.js']
			}, {
				name: 'svgo_worker_all_in.js',
				url: ['js/svgo_worker_all_in.js']
			}, {
				name: 'wasm-im_worker_all_in.js',
				url: ['js/wasm-im_worker_all_in.js']
			}, {
				name: 'logo.png',
				url: ['images/logo.png']
			}, {
				name: '1920x1080.jpg',
				url: ['images/1920x1080.jpg']
			}, {
				name: '750x1350.jpg',
				url: ['images/750x1350.jpg']
			}, {
				name: '500x500.jpg',
				url: ['images/500x500.jpg']
			},
			// 
			{
				name: 'magickApi.js',
				url: ['js/magick/magickApi.js']
			},
			{
				name: 'magick.js',
				url: ['js/magick/magick.js']
			}
		]
		// let cdnList = [{
		// 		name: 'avif_enc_worker_all_in.js',
		// 		url: ['./cache/js/avif_enc_worker_all_in.js']
		// 	}, {
		// 		name: 'imagequant_worker_all_in.js',
		// 		url: ['./cache/js/imagequant_worker_all_in.js']
		// 	}, {
		// 		name: 'squoosh_oxipng_worker_all_in.js',
		// 		url: ['./cache/js/squoosh_oxipng_worker_all_in.js']
		// 	}, {
		// 		name: 'mozjpeg_enc_worker_all_in.js',
		// 		url: ['./cache/js/mozjpeg_enc_worker_all_in.js']
		// 	}, {
		// 		name: 'svgo_worker_all_in.js',
		// 		url: ['./cache/js/svgo_worker_all_in.js']
		// 	}, {
		// 		name: 'wasm-im_worker_all_in.js',
		// 		url: ['./cache/js/wasm-im_worker_all_in.js']
		// 	}, {
		// 		name: 'logo.png',
		// 		url: ['./cache/images/logo.png']
		// 	}, {
		// 		name: '1920x1080.jpg',
		// 		url: ['./cache/images/1920x1080.jpg']
		// 	}, {
		// 		name: '750x1350.jpg',
		// 		url: ['./cache/images/750x1350.jpg']
		// 	}, {
		// 		name: '500x500.jpg',
		// 		url: ['./cache/images/500x500.jpg']
		// 	},
		// 	// 
		// 	{
		// 		name: 'magickApi.js',
		// 		url: ['./cache/js/magick/magickApi.js']
		// 	},
		// 	{
		// 		name: 'magick.js',
		// 		url: ['./cache/js/magick/magick.js']
		// 	}
		// ]

		cdnList = cdnList.map(m => {
			m.url = ['https://cdn.jsdelivr.net/gh/snnnnnnnn/Webp2Jpg/cdn/v3.0/' + m.url[0]]
			return m
		})


		function creatScript(src, name) {
			let body = document.querySelector('body')
			let script = document.createElement('script')
			script.src = src
			script.className = name
			body.appendChild(script)
		}


		start(0)
		async function start(num) {
			if (num > 2) return
			let ver = await idbKeyval.get('CACHE_VERSION')
			let blobList = await idbKeyval.get('CACHE_LIST')
			// 重新请求
			if (!ver || ver !== window.CACHE_VERSION || !blobList) {
				// await idbKeyval.clear()
				let retList = await getCdnList(cdnList)
				await idbKeyval.set('CACHE_LIST', retList)
			}
			blobList = await idbKeyval.get('CACHE_LIST')
			let errorList = blobList.some(f => !f.blob || !f.name)
			if (errorList) {
				alert('错误')
				await idbKeyval.del('CACHE_VERSION')
				start(num + 1)
				return
			}
			blobList.map(m => {
				window.CACHE_LIST[m.name] = URL.createObjectURL(m.blob)
			})
			await idbKeyval.set('CACHE_VERSION', window.CACHE_VERSION)
			creatScript(window.CACHE_LIST['app.js'], 'appJs')
			// console.log('window.CACHE_LIST', window.CACHE_LIST);
			// console.log('blobList', blobList);
			// console.log(window.CACHE_LIST['magickApi.js']);
			import(window.CACHE_LIST['magickApi.js'])
				.then(module => {
					Window.Magick = module
					console.log(Window.Magick);
				})
				.catch(err => {
					console.log(err);
				});
			console.log('加载完成✅', );


		}
		async function getCdnList(cdnList) {
			let time = new Date().getTime()
			let retList = []
			document.querySelector('.loadPage').style.display = 'flex'
			for (let index = 0; index < cdnList.length; index++) {
				const cdn = cdnList[index];
				// end
				// await new Promise(_ => setTimeout(() => _(), 300))
				let file = await fetchFile(cdn.url)
				if (!file) {
					file = {
						name: null,
						blob: null
					}
					console.error('GET ERRPR!', file);
				}
				retList.push({
					name: cdn.name,
					blob: file.blob
				})
				// console.log(cdn.name);
				// if(cdn.name==='app.js'){
				// 	creatScript(window.CACHE_LIST['app.js'],'appJs')
				// }
				console.log('+', index + 1)
				let pNum = ((index + 1) / cdnList.length * 100).toFixed(0) + '%'
				document.querySelector('.loadPage h2').textContent = pNum
				document.querySelector('.loadPage .p div').style.width = pNum
			}
			// await idbKeyval.set('cdnList', retList)
			time = new Date().getTime() - time
			time = (time / 1000).toFixed(2)
			console.log('缓存完成！', time);
			document.querySelector('.loadPage').style.display = 'none'

			return retList

		}
		async function fetchFile(url = []) {
			return new Promise(async (res, rej) => {
				let blob;
				for (let index = 0; index < url.length; index++) {
					const element = url[index];
					blob = await fetch(element)
						.then(d => {
							if (d.status === 200) return d.blob()
							else return null
						})
						.catch(e => {
							console.log(e);
							return null
						})
					if (blob) {
						res({
							blob,
							index,
							element
						})
						break
					} else {
						console.error('ERROR URL:', element);
					}
				}
				if (!blob) res(null)
			})



		}
	}
	window.CACHE_FN()
</script>